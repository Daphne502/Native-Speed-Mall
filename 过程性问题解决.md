# 过程性问题解决

说明：此文档旨在于记录并总结项目跟进过程中出现的问题和对应的解决方案

## Q1：CSS `line-clamp` 兼容性警告

### Q1问题说明

```css
/* Products 商品区域 */
/* ······· */
/* Product Card */
.product-name {
font-size: var(--font-size-base);
font-weight: 600;
color: var(--color-black);
line-height: 1.4;
display: -webkit-box;
-webkit-line-clamp: 2;  /*出现报错*/
-webkit-box-orient: vertical;
overflow: hidden;
min-height: 2.8em;
}
```

这段代码中，出现了**Warning警告**：
`“Also define the standard property 'line-clamp' for compatibility”。`

### Q1问题分析

Warning来自**IDE（VS Code）**，它提示：

> **你使用了带 `-webkit-` 前缀的私有属性，但没有定义标准属性**

*在此说明 “私有属性” 和 “标准属性”：*

| 属性 | 类型 | 浏览器支持 |
|------|------|-----------|
| `-webkit-line-clamp` | 私有前缀 |  所有现代浏览器都支持 |
| `line-clamp` | 标准属性 | 较新，部分浏览器支持 |

```css
-webkit-line-clamp: 2;   ← 私有属性（Webkit内核专用）
line-clamp: 2;           ← 标准属性（没有编写，Warning原因）
```

---

### Q1解决方案

添加标准的 `line-clamp` 属性即可：

```css
.product-name {
    /* ······ */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
    line-clamp: 2;              /* 添加标准属性 */
    overflow: hidden;
    
    min-height: 2.8em;
}
```

## Q2：Lighthouse CLS (累积布局偏移) 评分异常 (0.429)

### Q2问题说明

在进行 Lighthouse 跑分时，虽然 LCP 有所下降，但 **CLS (Cumulative Layout Shift)** 指标飙升至红色警告区域（0.429），导致总分无法突破 90 分。
**表现为：**
页面加载初期出现白色空白，当轮播图加载完成后，下方内容被瞬间“挤压”向下移动，造成视觉抖动。

相关部分的HTML代码片段：

```html
<img 
    src="./assets/images/banner-01.avif" 
    width="375" 
    height="164"  <!-- HTML中预留高度 -->
    class="banner-image"
>
```

相关部分的CSS代码片段：

```css
.banner-image {
    width: 100%;
    height: auto; /* 导致浏览器无法在图片下载前计算确切高度 */
}
```

### Q2问题分析

Warning 来自 Lighthouse Metrics，提示页面布局不稳定。
其核心冲突在于：图片实际尺寸、HTML 属性与 CSS 样式之间的计算冲突。

|阶段| 浏览器行为| 结果|
|:------|:------:|-----------|
|HTML解析 |读取 width="375" height="164" | 预留宽高比约为 2.28 |
|CSS解析 | 读取 height: auto | 覆盖了 HTML 的高度，根据宽度自动计算，但在图片未下载时高度可能塌陷为 0 或错误值 |
|图片加载后 | 获取图片真实尺寸 | 撑开容器，导致页面布局发生位移 (Layout Shift) |

### Q2解决方案

使用现代 CSS 属性 `aspect-ratio` 强制锁定容器比例，并配合 `object-fit` 解决微小的尺寸误差：

```css
.banner-image {
    width: 100%;
    /* aspect-ratio强制锁定宽高比：375 / 200 */
    /* 浏览器会在图片下载前就画好这个比例的框，绝不跳动 */
    aspect-ratio: 375 / 200; 
    
    /* object-fit适配不同高度的图片 */
    /* 如果后续图片高度略有偏差（如 170px），裁剪多余部分，保持容器不变*/
    object-fit: cover; 
    display: block;
}
```

## Q3：LCP 时间过长与网络拥塞 (Network Congestion)

### Q3问题说明

在 Network 面板中发现，首屏 LCP (Largest Contentful Paint) 耗时超过 12s。
Lighthouse 诊断提示 `"Improve image delivery"`，并指出某张商品图体积高达 3.1 MB。

### Q3问题分析

这是典型的资源加载优先级与格式选择错误。

**“网络拥塞”：**
浏览器对同一域名的并发请求数有限（通常为 6 个）。巨大的非首屏图片占用了带宽，导致首屏 Banner 轮播图排队等待。

**资源类型：**
Banner 图 AVIF (30KB) 虽小，但被堵在后面无法下载
商品图 PNG (3.1MB) 体积巨大，且与 Banner 同时发起请求 (Eager Load)

### Q3解决方案

采取 **个别体积极大商品图瘦身 + 懒加载 loading="lazy"** 策略：
**注意：**
>这里只选择个别体积极大商品图进行格式转化是因为在没有优化前，所有商品图都是以png格式进行跑分。为了权衡LCP和优化性能的客观，所以只对两个商品图进行了格式的转化

**格式转换**：将个别体积极大商品图的 PNG 转换为 AVIF，体积从 3MB 降至 200KB 以内。进而保证了所有的商品图的体积**最高不超过900KB**（最大为878KB）

**懒加载**：给首屏图片设置 `fetchpriority` 最高优先级，给非首屏图片添加 `loading="lazy"` 和 `decoding="async"`

HTML 修改如下：

```html
<!-- Banner图：保持高优先级 -->
<img 
    src="./assets/images/banner-01-640.avif" 
    <!-- ... -->
    fetchpriority="high"
>
<!-- 商品图：改为 AVIF 并添加懒加载 -->
<img 
    src="./assets/images/product-nut.png" 
    <!-- ... -->
    loading="lazy"
    decoding="async"
>
```

## Q4：关键资源加载发现延迟 (LCP Request Discovery)

### Q4问题说明

Lighthouse 提示 `"LCP request discovery"` 问题。
虽然 CSS 已经外链并压缩，但浏览器必须先下载并解析完 .css 文件，构建出 CSSOM 树后，才知道 `<div class="banner">` 里需要一张背景图或确认 `<img>` 的样式，这导致 LCP 图片的下载启动时间被推迟。

### Q4问题分析

**浏览器的渲染关键路径 (Critical Rendering Path) 机制：**
HTML -> 下载 CSS -> 解析 CSS -> 发现需要加载图片 -> 下载图片

在 CSS 下载完成前，图片请求处于 “被阻塞” 或 “未发现” 状态。

### Q4解决方案

使用 `<link rel="preload">` 预加载技术，将图片下载提前到与 CSS 下载并行进行。

```html
<head>
    <!-- ... -->
    <!-- 让图片下载提前到与css下载并行 -->
    <link 
        rel="preload" 
        as="image" 
        href="./assets/images/banner-01-640.avif" 
        fetchpriority="high"
    >
    <!-- CSS 样式表 -->
    <link rel="stylesheet" href="./assets/css/style.min.css">
</head>
```

此改动直接消除了“发现延迟”，使 LCP 时间显著缩短。
